<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Game Account Marketplace — Single File App</title>
  <!-- Bootstrap 5 CDN for quick styling (single file app) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    /* Small custom styles */
    body { padding-top: 70px; background:#f8f9fa; }
    .card-media { height:160px; object-fit:cover; background: #e9ecef; }
    .pointer { cursor:pointer; }
    .admin-badge { font-weight:600; color:#fff; background:#0d6efd; padding:2px 8px; border-radius:8px; font-size:12px; }
    .small-muted { font-size:13px; color:#6c757d; }
    .tag { background:#e7f1ff; padding:2px 8px; border-radius:999px; margin-right:6px; font-size:12px; }
    .required { color: #d63384; }
    .nav-active { font-weight:600; color:#0d6efd; }
    .footer { padding:20px 0; color:#6c757d; text-align:center; }
  </style>
</head>
<body>

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg fixed-top navbar-light bg-white border-bottom">
  <div class="container">
    <a class="navbar-brand" href="#home">GameAccountShop</a>
    <button class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navMenu"><span class="navbar-toggler-icon"></span></button>
    <div class="collapse navbar-collapse" id="navMenu">
      <ul class="navbar-nav me-auto">
        <li class="nav-item"><a class="nav-link pointer" data-route="#home">Trang chủ</a></li>
        <li class="nav-item"><a class="nav-link pointer" data-route="#products">Sản phẩm</a></li>
      </ul>
      <div class="d-flex align-items-center gap-2">
        <span id="nav-user-area"></span>
        <a class="btn btn-outline-secondary btn-sm" href="#cart" id="btn-cart">Giỏ hàng (<span id="cart-count">0</span>)</a>
        <a class="btn btn-primary btn-sm" href="#admin-login">Admin</a>
      </div>
    </div>
  </div>
</nav>

<!-- MAIN CONTAINER -->
<div class="container" id="app">

  <!-- VIEWS SWITCHED BY JS -->
  <div id="view-home" class="view">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3>Trang chủ - Sản phẩm nổi bật</h3>
      <div>
        <input id="search-input" class="form-control form-control-sm" placeholder="Tìm kiếm (tên, game, tag)..." style="min-width:280px;">
      </div>
    </div>

    <div class="row mb-4" id="featured-row"></div>

    <h5>Danh sách sản phẩm</h5>
    <div class="d-flex mb-3 gap-2">
      <select id="filter-game" class="form-select form-select-sm" style="width:200px">
        <option value="">-- Lọc theo Game --</option>
      </select>
      <select id="filter-status" class="form-select form-select-sm" style="width:160px">
        <option value="">Tất cả trạng thái</option>
        <option value="in_stock">Còn hàng</option>
        <option value="out_of_stock">Hết hàng</option>
      </select>
      <select id="sort-order" class="form-select form-select-sm" style="width:160px">
        <option value="new">Mới nhất</option>
        <option value="price_asc">Giá tăng dần</option>
        <option value="price_desc">Giá giảm dần</option>
      </select>
    </div>

    <div class="row" id="product-grid"></div>
  </div>

  <!-- Product detail view -->
  <div id="view-product" class="view" style="display:none">
    <button class="btn btn-link mb-2" data-route="#home">&larr; Quay lại</button>
    <div class="card mb-3">
      <div class="row g-0">
        <div class="col-md-5">
          <img id="detail-media" src="" alt="media" class="img-fluid card-media w-100">
        </div>
        <div class="col-md-7">
          <div class="card-body">
            <h4 id="detail-title"></h4>
            <div class="small-muted mb-2" id="detail-game"></div>
            <div id="detail-tags" class="mb-2"></div>
            <h5 class="text-danger" id="detail-price"></h5>
            <p id="detail-desc"></p>
            <div class="mb-3">
              <span class="badge bg-success" id="detail-status"></span>
            </div>
            <div class="d-flex gap-2">
              <input type="number" id="detail-qty" class="form-control" style="width:100px" value="1" min="1">
              <button id="detail-add" class="btn btn-primary">Thêm vào giỏ</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Cart -->
  <div id="view-cart" class="view" style="display:none">
    <h3>Giỏ hàng</h3>
    <div id="cart-list"></div>
    <div class="mt-3 d-flex justify-content-between align-items-center">
      <div><strong>Tổng cộng:</strong> <span id="cart-total">0</span> VND</div>
      <div>
        <a class="btn btn-secondary me-2" data-route="#products">Tiếp tục mua</a>
        <button id="checkout-btn" class="btn btn-success">Thanh toán (mô phỏng)</button>
      </div>
    </div>
  </div>

  <!-- Checkout (modal-like) -->
  <div id="checkout-area" style="display:none" class="mt-3">
    <h4>Thanh toán (mô phỏng)</h4>
    <div class="card p-3">
      <div class="mb-2">
        <label class="form-label">Số điện thoại liên hệ <span class="required">*</span></label>
        <input id="checkout-phone" class="form-control" placeholder="0912xxxxxx">
      </div>
      <div class="mb-2">
        <label class="form-label">Ghi chú</label>
        <textarea id="checkout-note" class="form-control" rows="2" placeholder="Ghi chú thêm..."></textarea>
      </div>
      <div class="mb-2">
        <label class="form-label">Phương thức thanh toán</label>
        <select id="checkout-method" class="form-select">
          <option value="fake_card">Thẻ (giả lập)</option>
          <option value="cod">Thanh toán khi nhận hàng (COD)</option>
        </select>
      </div>
      <div class="d-flex justify-content-between">
        <button class="btn btn-secondary" id="checkout-cancel">Hủy</button>
        <button class="btn btn-primary" id="checkout-confirm">Xác nhận & Thanh toán</button>
      </div>
    </div>
  </div>

  <!-- Auth: Login / Register -->
  <div id="view-auth" class="view" style="display:none">
    <div class="row">
      <div class="col-md-5">
        <h4>Đăng nhập</h4>
        <div class="card p-3">
          <div class="mb-2"><input id="login-email" class="form-control" placeholder="Email"></div>
          <div class="mb-2"><input id="login-password" type="password" class="form-control" placeholder="Mật khẩu"></div>
          <div class="d-flex gap-2">
            <button id="btn-login" class="btn btn-primary">Đăng nhập</button>
            <button id="btn-to-register" class="btn btn-link">Tạo tài khoản</button>
          </div>
        </div>
      </div>
      <div class="col-md-7">
        <h4>Đăng ký</h4>
        <div class="card p-3">
          <div class="mb-2"><input id="reg-username" class="form-control" placeholder="Tên hiển thị"></div>
          <div class="mb-2"><input id="reg-email" class="form-control" placeholder="Email"></div>
          <div class="mb-2"><input id="reg-password" type="password" class="form-control" placeholder="Mật khẩu"></div>
          <div class="mb-2"><input id="reg-password2" type="password" class="form-control" placeholder="Nhập lại mật khẩu"></div>
          <div class="d-flex gap-2">
            <button id="btn-register" class="btn btn-success">Đăng ký</button>
            <button id="btn-cancel-register" class="btn btn-link">Hủy</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- User orders -->
  <div id="view-orders" class="view" style="display:none">
    <h3>Lịch sử đơn hàng</h3>
    <div id="user-orders-list"></div>
  </div>

  <!-- Admin area -->
  <div id="view-admin-login" class="view" style="display:none">
    <h3>Admin — Đăng nhập</h3>
    <div class="card p-3" style="max-width:480px">
      <div class="mb-2"><input id="admin-email" class="form-control" placeholder="Admin email"></div>
      <div class="mb-2"><input id="admin-password" type="password" class="form-control" placeholder="Mật khẩu"></div>
      <div class="d-flex gap-2">
        <button id="btn-admin-login" class="btn btn-primary">Đăng nhập</button>
        <button class="btn btn-link" data-route="#home">Hủy</button>
      </div>
      <div class="text-muted mt-2">Admin mặc định: admin@example.com / 123456 (nếu là lần chạy đầu).</div>
    </div>
  </div>

  <div id="view-admin-panel" class="view" style="display:none">
    <div class="d-flex justify-content-between align-items-center">
      <h3>Admin Dashboard</h3>
      <div>
        <button id="btn-admin-logout" class="btn btn-outline-secondary btn-sm">Đăng xuất Admin</button>
      </div>
    </div>

    <div class="row my-3">
      <div class="col-md-4">
        <div class="card p-3">
          <div>Tổng sản phẩm</div>
          <h4 id="admin-total-products">0</h4>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card p-3">
          <div>Tổng đơn hàng</div>
          <h4 id="admin-total-orders">0</h4>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card p-3">
          <div>Doanh thu (tính các đơn đã thanh toán)</div>
          <h4 id="admin-revenue">0 VND</h4>
        </div>
      </div>
    </div>

    <hr>

    <div>
      <h5>Quản lý sản phẩm</h5>
      <div class="card p-3 mb-3">
        <form id="admin-product-form">
          <input type="hidden" id="prod-id">
          <div class="row">
            <div class="col-md-6 mb-2"><input id="prod-title" class="form-control" placeholder="Tiêu đề (ví dụ: Acc LOL - Challenger)"></div>
            <div class="col-md-3 mb-2"><input id="prod-game" class="form-control" placeholder="Game (ví dụ: Liên Minh)"></div>
            <div class="col-md-3 mb-2"><input id="prod-price" type="number" class="form-control" placeholder="Giá (VND)"></div>
          </div>
          <div class="mb-2"><input id="prod-sku" class="form-control" placeholder="Mã SKU"></div>
          <div class="mb-2"><textarea id="prod-desc" class="form-control" rows="2" placeholder="Mô tả chi tiết"></textarea></div>
          <div class="mb-2 d-flex gap-2">
            <input id="prod-tag" class="form-control" placeholder="Tag (ví dụ: rank:Challenger)"><button id="add-tag" type="button" class="btn btn-outline-secondary">Thêm tag</button>
          </div>
          <div id="tag-list" class="mb-2"></div>
          <div class="mb-2">
            <label class="form-label">Ảnh (URL hoặc upload file)</label>
            <input id="prod-media-url" class="form-control mb-2" placeholder="https://... hoặc để trống">
            <input id="prod-media-file" type="file" class="form-control">
          </div>
          <div class="mb-2">
            <select id="prod-status" class="form-select">
              <option value="in_stock">Còn hàng</option>
              <option value="out_of_stock">Hết hàng</option>
            </select>
          </div>
          <div class="d-flex gap-2">
            <button class="btn btn-success" id="save-product">Lưu / Thêm sản phẩm</button>
            <button class="btn btn-secondary" id="reset-product" type="button">Reset</button>
          </div>
        </form>
      </div>

      <div class="mb-4">
        <input id="admin-search-prod" class="form-control form-control-sm mb-2" placeholder="Tìm sản phẩm để edit/delete...">
        <div id="admin-products-table"></div>
      </div>

      <h5>Quản lý đơn hàng</h5>
      <div class="mb-2">
        <button id="export-orders" class="btn btn-outline-primary btn-sm">Export Orders CSV</button>
      </div>
      <div id="admin-orders-table"></div>
    </div>
  </div>

  <div class="footer mt-5">Single-file demo · Dữ liệu lưu trên localStorage · Nếu deploy thật, cần backend & DB</div>

</div>

<!-- Bootstrap JS & dependencies -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
/*
  Single-file Game Account Marketplace
  - Lưu dữ liệu tạm thời trong localStorage:
    - users: [{id, username, email, passwordHash, isAdmin}]
    - products: [{id, sku, title, game, price, description, media: [url], tags:[], status}]
    - orders: [{id, userId, items:[{productId, price, qty}], total, contact:{phone,note}, status, createdAt}]
  - Admin mặc định seed khi lần đầu chạy:
    - email: admin@example.com, password: 123456
  - Password hashing: SHA-256 (Web Crypto).
  - Routing: URL hash (e.g., #home, #products, #admin-login, #admin-panel)
*/

/* ---------- Utilities ---------- */

// Simple unique id
const uid = (prefix='id') => prefix + '_' + Math.random().toString(36).substring(2,9);

// LocalStorage helpers
const LS = {
  get(key, def){ try { const x = JSON.parse(localStorage.getItem(key)); return x ?? def; } catch(e){ return def; } },
  set(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
};

// Async SHA-256 hashing to hex
async function hashSHA256(str){
  const enc = new TextEncoder();
  const data = enc.encode(str);
  const hashBuffer = await crypto.subtle.digest('SHA-256', data);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2,'0')).join('');
}

/* ---------- Data layer ---------- */

function seedInitialData(){
  // Seed admin user if no users exist
  let users = LS.get('users', []);
  if(!users || users.length === 0){
    // create admin with hashed password
    const admin = {
      id: uid('u'),
      username: 'Administrator',
      email: 'admin@example.com',
      // store hash synchronously by calling later — but we can't await here.
    };
    // Use promise to compute hash and save
    (async ()=>{
      const pwdHash = await hashSHA256('123456');
      admin.passwordHash = pwdHash;
      admin.isAdmin = true;
      users.push(admin);
      LS.set('users', users);
      console.log('Seeded admin: admin@example.com / 123456');
    })();
  }

  // Seed some products
  let products = LS.get('products', []);
  if(!products || products.length === 0){
    products = [
      {
        id: uid('p'),
        sku: 'LOL-CH-001',
        title: 'LMHT — Challenger Acc (Rank cao, nhiều skin)',
        game: 'Liên Minh Huyền Thoại',
        price: 1200000,
        description: 'Acc rank Challenger, nhiều skin hiếm, có lịch sử giao dịch sạch.',
        media: ['https://images.unsplash.com/photo-1604882353095-9a3e8d0f3a4d?q=80&w=1200&auto=format&fit=crop&ixlib=rb-4.0.3&s=44a6d7b7b9f5e37fd1e5d57e7d5c6baf'],
        tags: ['rank:Challenger','skin:rare'],
        status: 'in_stock',
        createdAt: Date.now()
      },
      {
        id: uid('p'),
        sku: 'FF-GOLD-01',
        title: 'Free Fire — Gold Acc (Full skin cơ bản)',
        game: 'Free Fire',
        price: 250000,
        description: 'Acc free fire level cao, full weapon skins cơ bản.',
        media: [],
        tags: ['level:high'],
        status: 'in_stock',
        createdAt: Date.now()-1000000
      },
      {
        id: uid('p'),
        sku: 'GI-START-01',
        title: 'Genshin — Starter (Có 4 nhân vật 5⭐)',
        game: 'Genshin Impact',
        price: 800000,
        description: 'Account có 4 nhân vật 5⭐ và nhiều tài nguyên, phù hợp cho người mới.',
        media: [],
        tags: ['5star:4'],
        status: 'in_stock',
        createdAt: Date.now()-500000
      }
    ];
    LS.set('products', products);
  }
}

seedInitialData();

/* ---------- App state ---------- */
let currentUser = LS.get('currentUser', null); // {id, username, email, isAdmin}
let cart = LS.get('cart', []); // [{productId, price, qty}]
const saveCart = ()=> LS.set('cart', cart);

/* ---------- Routing & UI helpers ---------- */

function showView(viewId){
  document.querySelectorAll('.view').forEach(v=> v.style.display='none');
  const view = document.getElementById(viewId);
  if(view) view.style.display = '';
  // update nav active
  document.querySelectorAll('[data-route]').forEach(el=>{
    if(el.dataset.route === location.hash) el.classList.add('nav-active'); else el.classList.remove('nav-active');
  });
  // hide checkout area by default
  document.getElementById('checkout-area').style.display = 'none';
}

function routeHandler(){
  const hash = location.hash || '#home';
  // determine view
  if(hash.startsWith('#home') || hash === '#') {
    renderHome();
    showView('view-home');
  } else if(hash.startsWith('#products')){
    renderProducts();
    showView('view-home');
  } else if(hash.startsWith('#product-')){
    const id = hash.split('-').slice(1).join('-');
    renderProductDetail(id);
    showView('view-product');
  } else if(hash === '#cart'){
    renderCart();
    showView('view-cart');
  } else if(hash === '#login' || hash === '#auth'){
    showView('view-auth');
  } else if(hash === '#orders'){
    renderUserOrders();
    showView('view-orders');
  } else if(hash === '#admin-login'){
    showView('view-admin-login');
  } else if(hash === '#admin-panel'){
    if(currentUser && currentUser.isAdmin) {
      renderAdminPanel();
      showView('view-admin-panel');
    } else {
      location.hash = '#admin-login';
    }
  } else {
    // default to home
    location.hash = '#home';
  }
  updateNavUserArea();
}

/* ---------- Nav user area ---------- */
function updateNavUserArea(){
  const area = document.getElementById('nav-user-area');
  if(currentUser){
    area.innerHTML = `
      <span class="me-2">Xin chào <strong>${currentUser.username}</strong> ${currentUser.isAdmin?'<span class="admin-badge">ADMIN</span>':''}</span>
      <a class="btn btn-link btn-sm" id="nav-logout">Đăng xuất</a>
      <a class="btn btn-link btn-sm" href="#orders">Đơn hàng</a>
    `;
    document.getElementById('nav-cart').disabled = false;
    const btnLogout = document.getElementById('nav-logout');
    if(btnLogout) btnLogout.addEventListener('click', ()=>{
      currentUser=null; LS.set('currentUser', null); routeHandler();
    });
  }else{
    area.innerHTML = `<a class="btn btn-outline-primary btn-sm" href="#auth">Đăng nhập / ĐK</a>`;
  }
  document.getElementById('cart-count').innerText = cart.reduce((s,it)=>s+it.qty,0);
}

/* ---------- Rendering: Home & Product Grid ---------- */

function renderHome(){
  // featured products (top 6 by createdAt desc)
  const products = LS.get('products', []);
  const featured = [...products].sort((a,b)=>b.createdAt - a.createdAt).slice(0,6);
  const fRow = document.getElementById('featured-row');
  fRow.innerHTML = '';
  for(const p of featured){
    const col = document.createElement('div'); col.className='col-md-4 mb-3';
    col.innerHTML = `
      <div class="card h-100">
        <img src="${p.media?.[0]||'https://via.placeholder.com/600x400?text=No+Image'}" class="card-img-top card-media" alt="">
        <div class="card-body">
          <h5 class="card-title">${p.title}</h5>
          <p class="small-muted">${p.game} • ${p.tags?.join(', ')||''}</p>
          <p class="text-danger fw-bold">${p.price.toLocaleString()} VND</p>
          <a class="btn btn-sm btn-outline-primary" href="#product-${p.id}">Chi tiết</a>
        </div>
      </div>
    `;
    fRow.appendChild(col);
  }

  // build filter game dropdown
  const games = Array.from(new Set(products.map(x=>x.game).filter(Boolean)));
  const selGame = document.getElementById('filter-game');
  selGame.innerHTML = '<option value=\"\">-- Lọc theo Game --</option>';
  for(const g of games) selGame.innerHTML += `<option value="${g}">${g}</option>`;
}

function renderProducts(){
  const products = LS.get('products', []);
  const grid = document.getElementById('product-grid');
  const q = (document.getElementById('search-input')?.value || '').toLowerCase();
  const gameFilter = document.getElementById('filter-game')?.value || '';
  const statusFilter = document.getElementById('filter-status')?.value || '';
  const sortOrder = document.getElementById('sort-order')?.value || 'new';
  let list = products.filter(p=>{
    const matchesQ = q ? (p.title||'').toLowerCase().includes(q) || (p.game||'').toLowerCase().includes(q) || (p.tags||[]).join(' ').toLowerCase().includes(q) : true;
    const matchesGame = gameFilter ? p.game === gameFilter : true;
    const matchesStatus = statusFilter ? p.status === statusFilter : true;
    return matchesQ && matchesGame && matchesStatus;
  });
  if(sortOrder === 'price_asc') list.sort((a,b)=>a.price-b.price);
  else if(sortOrder === 'price_desc') list.sort((a,b)=>b.price-a.price);
  else list.sort((a,b)=>b.createdAt - a.createdAt);

  grid.innerHTML = '';
  for(const p of list){
    const col = document.createElement('div'); col.className='col-md-4 mb-3';
    col.innerHTML = `
      <div class="card h-100">
        <img src="${p.media?.[0]||'https://via.placeholder.com/600x400?text=No+Image'}" class="card-img-top card-media" alt="">
        <div class="card-body d-flex flex-column">
          <h5 class="card-title">${p.title}</h5>
          <p class="small-muted mb-2">${p.game} • ${p.tags?.join(', ')||''}</p>
          <p class="text-danger fw-bold mb-2">${p.price.toLocaleString()} VND</p>
          <div class="mt-auto d-flex justify-content-between">
            <a class="btn btn-sm btn-outline-primary" href="#product-${p.id}">Chi tiết</a>
            <button class="btn btn-sm btn-primary add-to-cart" data-id="${p.id}" ${p.status==='out_of_stock'?'disabled':''}>Thêm</button>
          </div>
        </div>
      </div>
    `;
    grid.appendChild(col);
  }

  // attach add-to-cart listeners
  document.querySelectorAll('.add-to-cart').forEach(btn=>{
    btn.onclick = ()=> {
      const pid = btn.dataset.id;
      addToCart(pid,1);
      showToast('Đã thêm vào giỏ');
    }
  });
}

/* ---------- Product detail ---------- */
function renderProductDetail(id){
  const products = LS.get('products', []);
  const p = products.find(x=>x.id===id);
  if(!p){ alert('Sản phẩm không tồn tại'); location.hash='#home'; return; }
  document.getElementById('detail-media').src = p.media?.[0] || 'https://via.placeholder.com/900x600?text=No+Image';
  document.getElementById('detail-title').innerText = p.title;
  document.getElementById('detail-game').innerText = p.game;
  const tagsEl = document.getElementById('detail-tags');
  tagsEl.innerHTML = '';
  (p.tags||[]).forEach(t=> tagsEl.innerHTML += `<span class="tag">${t}</span>`);
  document.getElementById('detail-price').innerText = p.price.toLocaleString() + ' VND';
  document.getElementById('detail-desc').innerText = p.description || '';
  document.getElementById('detail-status').innerText = p.status === 'in_stock' ? 'Còn hàng' : 'Hết hàng';
  const addBtn = document.getElementById('detail-add');
  addBtn.onclick = ()=>{
    const qty = Math.max(1, parseInt(document.getElementById('detail-qty').value) || 1);
    addToCart(p.id, qty);
    showToast('Đã thêm vào giỏ');
  }
}

/* ---------- Cart functions ---------- */
function addToCart(productId, qty=1){
  const products = LS.get('products', []);
  const p = products.find(x=>x.id===productId);
  if(!p) return;
  const item = cart.find(i=>i.productId===productId);
  if(item) item.qty += qty;
  else cart.push({ productId, price: p.price, qty });
  saveCart();
  updateNavUserArea();
}

function renderCart(){
  const products = LS.get('products', []);
  const list = document.getElementById('cart-list');
  if(cart.length === 0){ list.innerHTML = '<div class="alert alert-info">Giỏ hàng rỗng</div>'; document.getElementById('cart-total').innerText = '0'; return; }
  let html = '<table class="table"><thead><tr><th>SP</th><th>Giá</th><th>Số lượng</th><th>Thành tiền</th><th></th></tr></thead><tbody>';
  let total = 0;
  for(const it of cart){
    const p = products.find(x=>x.id===it.productId) || {title:'(Đã xóa)', price:0};
    const sub = it.qty * it.price;
    total += sub;
    html += `<tr>
      <td>${p.title}</td>
      <td>${it.price.toLocaleString()}</td>
      <td><input type="number" data-id="${it.productId}" class="form-control form-control-sm cart-qty" style="width:90px" value="${it.qty}" min="1"></td>
      <td>${sub.toLocaleString()}</td>
      <td><button class="btn btn-sm btn-danger remove-item" data-id="${it.productId}">Xóa</button></td>
    </tr>`;
  }
  html += `</tbody></table>`;
  list.innerHTML = html;
  document.querySelectorAll('.cart-qty').forEach(inp=>{
    inp.addEventListener('change', ()=>{
      const id = inp.dataset.id; const v = Math.max(1, parseInt(inp.value)||1);
      const it = cart.find(x=>x.productId===id); if(it){ it.qty = v; saveCart(); renderCart(); updateNavUserArea(); }
    });
  });
  document.querySelectorAll('.remove-item').forEach(btn=> btn.onclick = ()=>{
    const id = btn.dataset.id; cart = cart.filter(x=>x.productId !== id); saveCart(); renderCart(); updateNavUserArea();
  });
  document.getElementById('cart-total').innerText = total.toLocaleString();
}

/* ---------- Checkout / Orders ---------- */

function openCheckout(){
  if(cart.length === 0){ alert('Giỏ hàng rỗng'); return; }
  if(!currentUser){ if(confirm('Bạn cần đăng nhập để đặt hàng. Chuyển đến trang đăng nhập?')) location.hash='#auth'; return; }
  document.getElementById('checkout-area').style.display = '';
  window.scrollTo({top:0, behavior:'smooth'});
}

function confirmCheckout(){
  // Validate phone
  const phone = document.getElementById('checkout-phone').value.trim();
  if(!phone){ alert('Nhập số điện thoại'); return; }
  const note = document.getElementById('checkout-note').value.trim();
  const method = document.getElementById('checkout-method').value;
  const order = {
    id: uid('o'),
    userId: currentUser.id,
    items: cart.map(c=> ({ productId: c.productId, price: c.price, qty: c.qty })),
    total: cart.reduce((s,it)=>s + it.price*it.qty, 0),
    contact: { phone, note, method },
    status: method === 'cod' ? 'pending' : 'paid', // simplistic: assume online sim -> paid
    createdAt: Date.now()
  };
  const orders = LS.get('orders', []);
  orders.push(order); LS.set('orders', orders);
  cart = []; saveCart();
  LS.set('cart', cart);
  showToast('Đặt hàng thành công!');
  document.getElementById('checkout-area').style.display = 'none';
  location.hash = '#orders';
}

function renderUserOrders(){
  if(!currentUser){ location.hash='#auth'; return; }
  const orders = (LS.get('orders', [])).filter(o=>o.userId===currentUser.id).sort((a,b)=>b.createdAt-a.createdAt);
  const products = LS.get('products', []);
  const el = document.getElementById('user-orders-list');
  if(orders.length === 0){ el.innerHTML = '<div class="alert alert-info">Bạn chưa có đơn hàng nào.</div>'; return; }
  let html = '';
  for(const o of orders){
    html += `<div class="card mb-2 p-3">
      <div class="d-flex justify-content-between">
        <div><strong>ID:</strong> ${o.id} • <small class="text-muted">${new Date(o.createdAt).toLocaleString()}</small></div>
        <div><span class="badge bg-${o.status==='paid'?'success': o.status==='delivered' ? 'primary' : 'warning'}">${o.status}</span></div>
      </div>
      <div class="mt-2"><strong>Tổng:</strong> ${o.total.toLocaleString()} VND</div>
      <div class="mt-2"><strong>Liên hệ:</strong> ${o.contact.phone} • ${o.contact.method}</div>
      <div class="mt-2"><strong>Items:</strong>
        <ul>${o.items.map(it=>`<li>${(products.find(p=>p.id===it.productId)?.title || '(Đã xóa)')} — ${it.qty} x ${it.price.toLocaleString()}</li>`).join('')}</ul>
      </div>
      <div class="small-muted">Ghi chú: ${o.contact.note || '-'}</div>
    </div>`;
  }
  el.innerHTML = html;
}

/* ---------- Admin functions ---------- */

function renderAdminPanel(){
  const products = LS.get('products', []);
  const orders = LS.get('orders', []);
  document.getElementById('admin-total-products').innerText = products.length;
  document.getElementById('admin-total-orders').innerText = orders.length;
  const revenue = orders.filter(o=>o.status==='paid' || o.status==='delivered').reduce((s,o)=>s+o.total, 0);
  document.getElementById('admin-revenue').innerText = revenue.toLocaleString() + ' VND';

  // products table
  const table = document.getElementById('admin-products-table');
  if(products.length===0) table.innerHTML = '<div class="alert alert-info">Chưa có sản phẩm</div>';
  else {
    let html = '<table class="table table-sm"><thead><tr><th>SKU</th><th>Tiêu đề</th><th>Game</th><th>Giá</th><th>Trạng thái</th><th></th></tr></thead><tbody>';
    for(const p of products){
      html += `<tr>
        <td>${p.sku || ''}</td>
        <td>${p.title}</td>
        <td>${p.game || ''}</td>
        <td>${p.price.toLocaleString()}</td>
        <td>${p.status === 'in_stock' ? 'Còn' : 'Hết'}</td>
        <td>
          <button class="btn btn-sm btn-outline-primary edit-prod" data-id="${p.id}">Edit</button>
          <button class="btn btn-sm btn-outline-danger del-prod" data-id="${p.id}">Delete</button>
        </td>
      </tr>`;
    }
    html += '</tbody></table>';
    table.innerHTML = html;
    document.querySelectorAll('.edit-prod').forEach(b=> b.onclick = ()=> loadProductToForm(b.dataset.id));
    document.querySelectorAll('.del-prod').forEach(b=> b.onclick = ()=> {
      if(confirm('Xóa sản phẩm?')){ deleteProduct(b.dataset.id); renderAdminPanel(); showToast('Đã xóa'); }
    });
  }

  // orders table
  const ordTable = document.getElementById('admin-orders-table');
  if(orders.length===0) ordTable.innerHTML = '<div class="alert alert-info">Chưa có đơn hàng</div>';
  else {
    let html = '<table class="table table-sm"><thead><tr><th>ID</th><th>Người mua</th><th>Tổng</th><th>Trạng thái</th><th></th></tr></thead><tbody>';
    const users = LS.get('users', []);
    for(const o of orders.sort((a,b)=>b.createdAt-a.createdAt)){
      const u = users.find(us=>us.id===o.userId) || {username:'(Người dùng đã xóa)'};
      html += `<tr>
        <td>${o.id}</td>
        <td>${u.username}</td>
        <td>${o.total.toLocaleString()}</td>
        <td>${o.status}</td>
        <td>
          <select class="form-select form-select-sm order-status" data-id="${o.id}" style="width:140px;display:inline-block">
            <option ${o.status==='pending'?'selected':''} value="pending">pending</option>
            <option ${o.status==='paid'?'selected':''} value="paid">paid</option>
            <option ${o.status==='delivered'?'selected':''} value="delivered">delivered</option>
          </select>
        </td>
      </tr>`;
    }
    html += '</tbody></table>';
    ordTable.innerHTML = html;
    document.querySelectorAll('.order-status').forEach(sel=> sel.onchange = ()=>{
      const id = sel.dataset.id; const val = sel.value;
      const orders = LS.get('orders', []);
      const o = orders.find(x=>x.id===id); if(o){ o.status = val; LS.set('orders', orders); renderAdminPanel(); showToast('Đã cập nhật trạng thái'); }
    });
  }
}

/* Admin add/edit product form handlers */
let currentEditTags = [];
document.getElementById('add-tag').addEventListener('click', ()=>{
  const t = document.getElementById('prod-tag').value.trim();
  if(!t) return;
  currentEditTags.push(t); document.getElementById('prod-tag').value=''; renderTagList();
});
function renderTagList(){
  const el = document.getElementById('tag-list'); el.innerHTML = '';
  currentEditTags.forEach((t,idx)=> {
    const span = document.createElement('span'); span.className='tag pointer me-1';
    span.innerText = t + ' ×';
    span.onclick = ()=> { currentEditTags.splice(idx,1); renderTagList(); };
    el.appendChild(span);
  });
}
document.getElementById('reset-product').addEventListener('click', ()=> resetProductForm());
function resetProductForm(){
  document.getElementById('prod-id').value=''; document.getElementById('prod-title').value=''; document.getElementById('prod-game').value='';
  document.getElementById('prod-price').value=''; document.getElementById('prod-sku').value=''; document.getElementById('prod-desc').value='';
  document.getElementById('prod-media-url').value=''; document.getElementById('prod-media-file').value=''; currentEditTags=[]; renderTagList();
}

function loadProductToForm(id){
  const products = LS.get('products', []);
  const p = products.find(x=>x.id===id);
  if(!p) return;
  document.getElementById('prod-id').value = p.id;
  document.getElementById('prod-title').value = p.title;
  document.getElementById('prod-game').value = p.game;
  document.getElementById('prod-price').value = p.price;
  document.getElementById('prod-sku').value = p.sku;
  document.getElementById('prod-desc').value = p.description;
  document.getElementById('prod-media-url').value = p.media?.[0] || '';
  currentEditTags = p.tags ? [...p.tags] : [];
  document.getElementById('prod-status').value = p.status || 'in_stock';
  renderTagList();
}

async function handleSaveProduct(e){
  e.preventDefault();
  const id = document.getElementById('prod-id').value;
  const title = document.getElementById('prod-title').value.trim();
  const game = document.getElementById('prod-game').value.trim();
  const price = parseInt(document.getElementById('prod-price').value) || 0;
  const sku = document.getElementById('prod-sku').value.trim();
  const desc = document.getElementById('prod-desc').value.trim();
  const mediaUrl = document.getElementById('prod-media-url').value.trim();
  const mediaFile = document.getElementById('prod-media-file').files[0];
  const status = document.getElementById('prod-status').value;
  if(!title || !game || !price){ alert('Vui lòng nhập title, game và price'); return; }
  // if file uploaded, convert to base64
  let media = [];
  if(mediaFile){
    media.push(await fileToBase64(mediaFile));
  } else if(mediaUrl) media.push(mediaUrl);

  const products = LS.get('products', []);
  if(id){
    // update
    const p = products.find(x=>x.id===id);
    if(!p) return;
    p.title = title; p.game = game; p.price = price; p.sku = sku; p.description = desc;
    if(media.length>0) p.media = media;
    p.tags = [...currentEditTags];
    p.status = status;
    LS.set('products', products);
    showToast('Sản phẩm cập nhật');
  } else {
    // create
    const p = { id: uid('p'), sku, title, game, price, description: desc, media, tags: [...currentEditTags], status, createdAt: Date.now() };
    products.push(p); LS.set('products', products);
    showToast('Đã thêm sản phẩm');
  }
  resetProductForm(); renderAdminPanel(); renderProducts(); renderHome();
}
document.getElementById('save-product').addEventListener('click', handleSaveProduct);

function deleteProduct(id){
  let products = LS.get('products', []);
  products = products.filter(x=>x.id !== id);
  LS.set('products', products);
  renderProducts(); renderHome();
}

function fileToBase64(file){
  return new Promise((res,rej)=>{
    const fr = new FileReader();
    fr.onload = ()=> res(fr.result);
    fr.onerror = rej;
    fr.readAsDataURL(file);
  });
}

/* ---------- Admin export CSV ---------- */
function exportOrdersCSV(){
  const orders = LS.get('orders', []);
  if(orders.length===0){ alert('Không có đơn hàng'); return; }
  const users = LS.get('users', []);
  const products = LS.get('products', []);
  const rows = orders.map(o=>{
    return {
      id: o.id,
      user: (users.find(u=>u.id===o.userId)?.username) || '',
      email: (users.find(u=>u.id===o.userId)?.email) || '',
      total: o.total,
      status: o.status,
      phone: o.contact.phone || '',
      method: o.contact.method || '',
      note: o.contact.note || '',
      createdAt: new Date(o.createdAt).toLocaleString(),
      items: o.items.map(it => (products.find(p=>p.id===it.productId)?.title || '(Đã xóa)') + ' x'+it.qty).join('; ')
    }
  });
  // CSV stringify simple
  const header = Object.keys(rows[0]).join(',');
  const csv = [header].concat(rows.map(r => Object.values(r).map(v => `"${String(v).replace(/"/g,'""')}"`).join(','))).join('\\n');
  const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download = 'orders.csv'; a.click();
  URL.revokeObjectURL(url);
}
document.getElementById('export-orders').addEventListener('click', exportOrdersCSV);

/* ---------- Auth: register / login / admin-login ---------- */

document.getElementById('btn-register').addEventListener('click', async ()=>{
  const username = document.getElementById('reg-username').value.trim();
  const email = document.getElementById('reg-email').value.trim().toLowerCase();
  const pw = document.getElementById('reg-password').value;
  const pw2 = document.getElementById('reg-password2').value;
  if(!username || !email || !pw){ alert('Vui lòng điền đầy đủ'); return; }
  if(pw !== pw2){ alert('Mật khẩu không khớp'); return; }
  const users = LS.get('users', []);
  if(users.find(u=>u.email===email)){ alert('Email đã được sử dụng'); return; }
  const hash = await hashSHA256(pw);
  const user = { id: uid('u'), username, email, passwordHash: hash, isAdmin: false };
  users.push(user); LS.set('users', users);
  currentUser = { id: user.id, username: user.username, email: user.email, isAdmin: false };
  LS.set('currentUser', currentUser);
  showToast('Đăng ký thành công');
  location.hash = '#home';
});

document.getElementById('btn-login').addEventListener('click', async ()=>{
  const email = document.getElementById('login-email').value.trim().toLowerCase();
  const pw = document.getElementById('login-password').value;
  if(!email || !pw){ alert('Nhập email & mật khẩu'); return; }
  const users = LS.get('users', []);
  const user = users.find(u=>u.email===email);
  if(!user){ alert('Thông tin không đúng'); return; }
  const hash = await hashSHA256(pw);
  if(hash !== user.passwordHash){ alert('Thông tin không đúng'); return; }
  currentUser = { id: user.id, username: user.username, email: user.email, isAdmin: !!user.isAdmin };
  LS.set('currentUser', currentUser);
  showToast('Đăng nhập thành công');
  location.hash = '#home';
});

document.getElementById('btn-admin-login').addEventListener('click', async ()=>{
  const email = document.getElementById('admin-email').value.trim().toLowerCase();
  const pw = document.getElementById('admin-password').value;
  if(!email || !pw){ alert('Nhập email & mật khẩu'); return; }
  const users = LS.get('users', []);
  const user = users.find(u=>u.email===email && u.isAdmin);
  if(!user){ alert('Không tìm thấy admin'); return; }
  const hash = await hashSHA256(pw);
  if(hash !== user.passwordHash){ alert('Thông tin không đúng'); return; }
  currentUser = { id: user.id, username: user.username, email: user.email, isAdmin: true };
  LS.set('currentUser', currentUser);
  showToast('Login admin thành công');
  location.hash = '#admin-panel';
});

document.getElementById('btn-admin-logout').addEventListener('click', ()=>{
  currentUser = null; LS.set('currentUser', null); showToast('Admin logged out'); location.hash='#home';
});

/* ---------- Init & event wiring ---------- */

window.addEventListener('hashchange', routeHandler);
document.querySelectorAll('[data-route]').forEach(el=> el.addEventListener('click', ()=> { location.hash = el.dataset.route; }));

// search / filters
document.getElementById('search-input').addEventListener('input', ()=> renderProducts());
document.getElementById('filter-game').addEventListener('change', ()=> renderProducts());
document.getElementById('filter-status').addEventListener('change', ()=> renderProducts());
document.getElementById('sort-order').addEventListener('change', ()=> renderProducts());

// checkout buttons
document.getElementById('checkout-btn').addEventListener('click', openCheckout);
document.getElementById('checkout-cancel').addEventListener('click', ()=> document.getElementById('checkout-area').style.display='none');
document.getElementById('checkout-confirm').addEventListener('click', confirmCheckout);

// cart button nav
document.getElementById('btn-cart').addEventListener('click', ()=> { location.hash = '#cart'; });

// admin product search (live)
document.getElementById('admin-search-prod').addEventListener('input', function(){
  const q = this.value.trim().toLowerCase();
  const products = LS.get('products', []);
  const table = document.getElementById('admin-products-table');
  const list = products.filter(p=> p.title.toLowerCase().includes(q) || (p.sku||'').toLowerCase().includes(q) );
  if(list.length===0) table.innerHTML = '<div class="alert alert-info">Không tìm thấy</div>';
  else {
    let html = '<table class="table table-sm"><thead><tr><th>SKU</th><th>Tiêu đề</th><th>Game</th><th>Giá</th><th></th></tr></thead><tbody>';
    for(const p of list){
      html += `<tr><td>${p.sku||''}</td><td>${p.title}</td><td>${p.game||''}</td><td>${p.price.toLocaleString()}</td>
        <td><button class="btn btn-sm btn-outline-primary edit-prod" data-id="${p.id}">Edit</button>
        <button class="btn btn-sm btn-outline-danger del-prod" data-id="${p.id}">Delete</button></td></tr>`;
    }
    html += '</tbody></table>'; table.innerHTML = html;
    document.querySelectorAll('.edit-prod').forEach(b=> b.onclick = ()=> loadProductToForm(b.dataset.id));
    document.querySelectorAll('.del-prod').forEach(b=> b.onclick = ()=> { if(confirm('Xóa sản phẩm?')) { deleteProduct(b.dataset.id); renderAdminPanel(); showToast('Đã xóa'); }});
  }
});

// small toast
function showToast(msg, timeout=1800){
  const el = document.createElement('div');
  el.className = 'toast align-items-center text-bg-primary border-0 show';
  el.style.position='fixed'; el.style.right='20px'; el.style.top='80px'; el.style.zIndex=9999; el.style.padding='10px 16px';
  el.innerHTML = `<div class="d-flex"><div class="toast-body">${msg}</div><button class="btn-close btn-close-white ms-2 me-2" aria-label="Close"></button></div>`;
  document.body.appendChild(el);
  el.querySelector('.btn-close').onclick = ()=> el.remove();
  setTimeout(()=> el.remove(), timeout);
}

// initial render
(function init(){
  cart = LS.get('cart', []);
  currentUser = LS.get('currentUser', null);
  routeHandler();
  renderHome();
  renderProducts();
  renderAdminPanel();
  updateNavUserArea();
})();

</script>
</body>
</html>
